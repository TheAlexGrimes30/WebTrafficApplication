{% extends 'base.html' %}

{% block title %}Create new Record{% endblock %}

{% block content %}
  <h2 class="mb-4">Create New Record</h2>
  <form method="post">
    {% csrf_token %}

    <div class="mb-3">{{ form.status.label_tag }}{{ form.status }}</div>
    <div class="mb-3">{{ form.type_model.label_tag }}{{ form.type_model }}</div>

    <!-- Category -->
    <div class="mb-3">
      <label for="id_category">Category</label>
      <select id="id_category" name="category" class="form-select">
        <option value="">Не выбрано</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}">{{ cat.category_name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3" id="subcategory-wrapper" style="display: none;">
      <label for="id_subcategory">Subcategory</label>
      <select id="id_subcategory" name="subcategory" class="form-select">
        <option value="">Не выбрано</option>
        {% for sub in subcategories %}
          <option value="{{ sub.id }}" data-category="{{ sub.category.id }}">{{ sub.subcategory_name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">{{ form.sum_amount.label_tag }}{{ form.sum_amount }}</div>
    <div class="mb-3">{{ form.comment.label_tag }}{{ form.comment }}</div>
    <div class="mb-3">{{ form.date_created.label_tag }}{{ form.date_created }}</div>

    <div class="mt-3">
      <button type="submit" class="btn btn-primary">Save</button>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const categorySelect = document.getElementById('id_category');
      const subcategorySelect = document.getElementById('id_subcategory');
      const subcategoryWrapper = document.getElementById('subcategory-wrapper');
      const allOptions = Array.from(subcategorySelect.options).slice(1);

      categorySelect.addEventListener('change', function () {
        const selectedCategoryId = this.value;

        subcategorySelect.innerHTML = '<option value="">Не выбрано</option>';
        subcategoryWrapper.style.display = 'none';

        if (selectedCategoryId) {
          allOptions.forEach(option => {
            if (option.getAttribute('data-category') === selectedCategoryId) {
              subcategorySelect.appendChild(option);
            }
          });

          if (subcategorySelect.options.length > 1) {
            subcategoryWrapper.style.display = 'block';
          }
        }
      });
    });
  </script>
{% endblock %}
